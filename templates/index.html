<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Elastic Pendulum Playground</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&display=swap">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  </head>
  <body>
    <div class="app">
      <header class="header">
        <h1>Elastic Pendulum Playground</h1>
        <p>Type your numbers and press Go!</p>
      </header>

      <section class="controls">
        <form method="post" id="control-form" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
          <div class="field">
            <label for="phi">Phase (φ, radians)</label>
            <input type="number" step="0.01" id="phi" name="phi" placeholder="e.g. 0.0" value="{{ '%.3f' % meta['phase'] }}">
          </div>
          <div class="field">
            <label for="w">Angular speed (ω, rad/s)</label>
            <input type="number" step="0.01" id="w" name="w" placeholder="e.g. 6.283" value="{{ '%.3f' % meta['angular_speed'] }}">
          </div>
          <div class="field">
            <label for="xm">Amplitude (Xmax)</label>
            <input type="number" step="0.01" id="xm" name="xm" placeholder="e.g. 1.0" value="{{ '%.3f' % meta['amplitude'] }}">
          </div>
          <div class="field">
            <label for="tf">Final time (T<sub>f</sub>, s)</label>
            <input type="number" step="0.1" id="tf" name="tf" placeholder="e.g. 10" value="{{ '%.1f' % meta['final_time'] }}">
          </div>
          <button type="submit" class="btn">Go</button>
        </form>
      </section>

      <section class="visuals">
        <div class="visual-card">
          <h2>x, v, a vs time</h2>
          <div id="plot" class="plot"></div>
        </div>
        <div class="visual-card">
          <h2>Spring-Mass Motion</h2>
          <div id="animation" class="animation"></div>
        </div>
      </section>

      <footer class="footer">
        <small>Made for curious kids</small>
      </footer>
    </div>

    <script>
      const DATA = JSON.parse('{{ data_json|safe }}');

      // Plot x, v, a vs time
      (function renderPlot() {
        const t = DATA.times;
        const xTrace = { x: t, y: DATA.x, mode: 'lines', line: { color: '#1e88e5', width: 3 }, name: 'x' };
        const vTrace = { x: t, y: DATA.v, mode: 'lines', line: { color: '#43a047', width: 3 }, name: 'v' };
        const aTrace = { x: t, y: DATA.a, mode: 'lines', line: { color: '#e53935', width: 3 }, name: 'a' };
        const layout = {
          xaxis: { title: 'time t (s)' },
          yaxis: { title: 'value' },
          legend: { orientation: 'h' },
          margin: { t: 10, r: 10, b: 50, l: 50 },
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)'
        };
        Plotly.newPlot('plot', [xTrace, vTrace, aTrace], layout, {displayModeBar:false});
      })();

      // Simple vertical spring-mass animation using SVG
      (function renderAnimation() {
        const container = document.getElementById('animation');
        const width = 240;
        const height = 320;
        const svgNS = 'http://www.w3.org/2000/svg';

        const svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('width', width);
        svg.setAttribute('height', height);
        container.appendChild(svg);

        // Fixed ceiling
        const ceiling = document.createElementNS(svgNS, 'rect');
        ceiling.setAttribute('x', 0);
        ceiling.setAttribute('y', 0);
        ceiling.setAttribute('width', width);
        ceiling.setAttribute('height', 20);
        ceiling.setAttribute('fill', '#4dabf7');
        svg.appendChild(ceiling);

        // Spring path
        const spring = document.createElementNS(svgNS, 'path');
        spring.setAttribute('stroke', '#444');
        spring.setAttribute('stroke-width', '3');
        spring.setAttribute('fill', 'none');
        svg.appendChild(spring);

        // Mass
        const mass = document.createElementNS(svgNS, 'circle');
        mass.setAttribute('r', 18);
        mass.setAttribute('fill', '#ffd43b');
        mass.setAttribute('stroke', '#f59f00');
        mass.setAttribute('stroke-width', '3');
        svg.appendChild(mass);

        function springPath(x0, y0, x1, y1, coils = 8, amplitude = 10) {
          const dx = (x1 - x0) / coils;
          const dy = (y1 - y0) / coils;
          let d = `M ${x0} ${y0}`;
          for (let i = 1; i <= coils; i++) {
            const cx = x0 + dx * i + (i % 2 === 0 ? amplitude : -amplitude);
            const cy = y0 + dy * i;
            d += ` L ${cx} ${cy}`;
          }
          d += ` L ${x1} ${y1}`;
          return d;
        }

        // Scale physics x(t) to pixels
        const xs = DATA.x;
        const times = DATA.times;
        const minX = Math.min(...xs);
        const maxX = Math.max(...xs);
        const scale = maxX - minX === 0 ? 1 : 80 / (maxX - minX);

        const anchorX = width / 2;
        const anchorY = 20;
        const restLength = 120;

        let idx = 0;
        function animate() {
          const x = xs[idx];
          const y = anchorY + restLength + (-x * scale); // invert so positive x goes up
          mass.setAttribute('cx', anchorX);
          mass.setAttribute('cy', y);
          spring.setAttribute('d', springPath(anchorX, anchorY, anchorX, y - 18));

          idx = (idx + 1) % xs.length;
          requestAnimationFrame(animate);
        }
        animate();
      })();
    </script>
  </body>
  </html>


